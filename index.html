<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="robots" content="noindex, nofollow">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bleta's PhD Research Cronogram - Interactive Timeline</title>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600;700&family=Source+Sans+3:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1a3a52;
            --secondary: #2d5f7f;
            --accent: #d4772b;
            --success: #2d7a4f;
            --warning: #c9822b;
            --danger: #c92b2b;
            --bg: #fafbfc;
            --surface: #ffffff;
            --text: #1f2937;
            --text-light: #6b7280;
            --border: #e5e7eb;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Source Sans 3', sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            padding: 2rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 3rem 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        h1 {
            font-family: 'Crimson Pro', serif;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        h1[contenteditable="true"]:hover {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            padding: 0.25rem 0.5rem;
            margin: -0.25rem -0.5rem;
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .subtitle[contenteditable="true"]:hover {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            padding: 0.25rem 0.5rem;
            margin: -0.25rem -0.5rem;
        }

        .alert {
            background: #fef3c7;
            border-left: 4px solid var(--warning);
            padding: 1rem 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }

        .alert strong {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--warning);
        }

        .controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.95rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--secondary);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .btn-secondary {
            background: var(--surface);
            color: var(--text);
            border: 2px solid var(--border);
        }

        .btn-secondary:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #25633f;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .btn-danger {
            background: #dc2626;
            color: white;
            border: none;
        }

        .btn-danger:hover {
            background: #b91c1c;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .view-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--border);
        }

        .tab {
            padding: 1rem 1.5rem;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-light);
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--accent);
        }

        .view {
            display: none;
        }

        .view.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7);
            }
            50% {
                transform: scale(1.02);
                box-shadow: 0 0 0 10px rgba(220, 38, 38, 0);
            }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        table {
            width: 100%;
            background: var(--surface);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-bottom: 2rem;
        }

        thead {
            background: var(--primary);
            color: white;
        }

        th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
            position: relative;
        }

        th:hover {
            background: var(--secondary);
        }

        th.sortable::after {
            content: '‚áÖ';
            position: absolute;
            right: 1rem;
            opacity: 0.5;
        }

        th.sorted-asc::after {
            content: '‚Üë';
            opacity: 1;
        }

        th.sorted-desc::after {
            content: '‚Üì';
            opacity: 1;
        }

        tbody tr {
            border-bottom: 1px solid var(--border);
            transition: background 0.2s;
        }

        tbody tr:hover {
            background: #f9fafb;
        }

        td {
            padding: 1rem;
        }

        .editable {
            padding: 0.5rem;
            border: 1px solid transparent;
            border-radius: 4px;
            cursor: text;
            min-width: 80px;
            display: inline-block;
        }

        .editable:hover {
            border-color: var(--border);
            background: #f9fafb;
        }

        .editable:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
        }

        .priority-urgent {
            background: #fee2e2;
            color: var(--danger);
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .priority-high {
            background: #fef3c7;
            color: var(--warning);
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .priority-medium {
            background: #dbeafe;
            color: #1e40af;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .timeline {
            background: var(--surface);
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .week {
            margin-bottom: 2rem;
        }

        .week-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .week-title {
            font-weight: 700;
            font-size: 1.2rem;
        }

        .task-card {
            background: white;
            border-left: 4px solid var(--accent);
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            transition: all 0.2s;
            cursor: pointer;
            position: relative;
        }

        .task-card::after {
            content: 'üëÅÔ∏è Click for details';
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 0.75rem;
            color: var(--text-light);
            opacity: 0;
            transition: opacity 0.2s;
        }

        .task-card:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-left-width: 6px;
        }

        .task-card:hover::after {
            opacity: 1;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 0.5rem;
        }

        .task-title {
            font-weight: 600;
            color: var(--primary);
        }

        .task-duration {
            font-size: 0.85rem;
            color: var(--text-light);
            background: var(--bg);
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
        }

        .task-description {
            color: var(--text-light);
            font-size: 0.95rem;
            margin-bottom: 0.5rem;
        }

        .gantt {
            background: var(--surface);
            padding: 2rem;
            border-radius: 8px;
            overflow-x: auto;
            min-height: 400px;
        }

        .gantt-row {
            display: flex;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border);
            min-height: 60px;
        }

        .gantt-label {
            width: 250px;
            font-weight: 600;
            font-size: 1rem;
            flex-shrink: 0;
            padding-right: 1rem;
        }

        .gantt-bar-container {
            flex-grow: 1;
            height: 40px;
            position: relative;
            background: var(--bg);
            border-radius: 4px;
            border: 1px solid var(--border);
        }

        .gantt-bar {
            position: absolute;
            height: 100%;
            background: linear-gradient(135deg, var(--accent), #e89654);
            border-radius: 4px;
            display: flex;
            align-items: center;
            padding: 0 0.75rem;
            color: white;
            font-size: 0.8rem;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: move;
            transition: box-shadow 0.2s;
            min-width: 60px;
            overflow: hidden;
            white-space: nowrap;
        }

        .gantt-bar::before {
            content: '‚ãÆ‚ãÆ';
            position: absolute;
            left: 0.25rem;
            opacity: 0.6;
            font-size: 1rem;
            letter-spacing: -2px;
        }

        .gantt-bar:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            background: linear-gradient(135deg, #e89654, var(--accent));
            z-index: 5;
        }

        .gantt-bar.dragging {
            opacity: 0.8;
            cursor: grabbing;
            z-index: 10;
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 9999;
            animation: fadeIn 0.2s;
        }

        .modal.active {
            display: flex !important;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--surface);
            padding: 2rem;
            border-radius: 12px;
            max-width: 900px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            position: relative;
            z-index: 10000;
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: var(--bg);
            color: var(--text);
        }

        .modal-title {
            font-family: 'Crimson Pro', serif;
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
            color: var(--primary);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border);
            border-radius: 6px;
            font-size: 1rem;
            font-family: 'Source Sans 3', sans-serif;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 2px solid var(--border);
        }

        .btn-cancel {
            background: var(--bg);
            color: var(--text);
            border: 2px solid var(--border);
        }

        .btn-cancel:hover {
            background: #e5e7eb;
        }

        .form-hint {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-top: 0.25rem;
        }

        .sync-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 999;
        }

        .sync-indicator.show {
            opacity: 1;
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }

            .controls, .view-tabs, .btn, button, #syncIndicator, #corruptionWarning {
                display: none !important;
            }

            .container {
                max-width: 100%;
            }
            
            header {
                page-break-after: avoid;
                margin-bottom: 1rem;
            }
            
            .alert {
                page-break-inside: avoid;
            }
            
            table {
                page-break-inside: avoid;
                font-size: 10pt;
            }
            
            .view {
                display: block !important;
            }
            
            .view:not(.active) {
                page-break-before: always;
            }
            
            .gantt-bar {
                print-color-adjust: exact;
                -webkit-print-color-adjust: exact;
            }
            
            .task-card {
                page-break-inside: avoid;
                print-color-adjust: exact;
                -webkit-print-color-adjust: exact;
            }
            
            /* Hide interactive hints */
            .task-card::after {
                display: none !important;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }

            h1 {
                font-size: 1.8rem;
            }

            table {
                font-size: 0.9rem;
            }

            .gantt-label {
                width: 120px;
                font-size: 0.8rem;
            }

            .modal-content {
                margin: 1rem;
                max-width: calc(100% - 2rem);
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sync-indicator" id="syncIndicator">‚úì Views synchronized</div>
        
        <!-- Data corruption warning banner -->
        <div id="corruptionWarning" style="display: none; background: #fee2e2; border: 3px solid #dc2626; border-radius: 8px; padding: 1.5rem; margin-bottom: 2rem; animation: pulse 2s infinite;">
            <h3 style="color: #dc2626; margin-bottom: 0.5rem;">‚ö†Ô∏è DATA CORRUPTION DETECTED!</h3>
            <p style="margin-bottom: 1rem;">Your saved data is incomplete or corrupted. Some features may not work correctly.</p>
            <button class="btn btn-danger" onclick="resetData()" style="background: #dc2626; color: white; font-weight: bold; padding: 1rem 2rem; font-size: 1.1rem;">
                üîÑ CLICK HERE TO FIX - Reset to Original Data
            </button>
        </div>
        
        <header>
            <h1 contenteditable="true" style="outline: none; cursor: text;">Bleta's PhD Research Cronogram</h1>
            <p class="subtitle" contenteditable="true" style="outline: none; cursor: text;">3-Month Timeline for Four Concurrent Deliverables | February - April 2026</p>
        </header>

        <div class="alert" style="background:#e0f2fe; border-left-color:#1a3a52;">
            <strong>Timeline Note</strong>
            This timeline is a working plan and may be adjusted as the project evolves.
        </div>


        <div class="alert" style="background: #e0f2fe; border-left-color: var(--primary);">
            <strong>üí° Interactive Features</strong>
            <ul style="margin: 0.5rem 0 0 1.5rem; line-height: 1.8;">
                <li><strong>‚úì Mark tasks complete:</strong> Check the box in the Completed column to mark tasks as done</li>
                <li><strong>‚ûï Add new tasks:</strong> Click "Add New Task" button to create custom tasks</li>
                <li><strong>Edit anywhere:</strong> Click on dates, durations, or title to edit directly</li>
                <li><strong>Weekly Timeline:</strong> Click any task card to see detailed breakdown with completion status</li>
                <li><strong>Gantt Chart:</strong> Drag the bars left/right to adjust timelines</li>
                <li><strong>All views sync:</strong> Changes in one view update all others automatically</li>
                <li><strong>Remember to save:</strong> Click "üíæ Save Changes" to persist your edits</li>
            </ul>
        </div>

        <div class="alert" style="background: #fef3c7; border-left-color: #f59e0b;">
            <strong>üêõ Troubleshooting</strong>
            <p style="margin: 0.5rem 0 0 0;">If weekly timeline shows "No tasks found" or Gantt chart only shows "Other" ‚Üí Click the <strong style="background: #fef3c7; color: #92400e; padding: 0.2rem 0.5rem; border-radius: 4px;">üîÑ Reset All Data</strong> button to reload default tasks.</p>
        </div>

        <div class="controls">
            <button class="btn btn-success" onclick="openAddTaskModal()">‚ûï Add New Task</button>
            <button class="btn btn-primary" onclick="exportToExcel()">üìä Export to Excel</button>
            <button class="btn btn-secondary" onclick="printCronogram()">üñ®Ô∏è Print Cronogram</button>
            <button class="btn btn-secondary" onclick="resetData()" style="background: #fed7aa; color: #92400e; font-weight: 700; border: 2px solid #fb923c;">üîÑ Reset All Data</button>
            <button class="btn btn-secondary" onclick="saveData()">üíæ Save Changes</button>
            <button class="btn btn-secondary" onclick="showDebugInfo()" style="background: #fef3c7; color: #92400e;">üêõ Debug Info</button>
        </div>

        <div class="view-tabs">
            <button class="tab active" onclick="switchView('table')">üìã Task Table</button>
            <button class="tab" onclick="switchView('timeline')">üìÖ Weekly Timeline</button>
            <button class="tab" onclick="switchView('gantt')">üìä Gantt Chart</button>
        </div>

        <div id="tableView" class="view active">
            <h2 style="margin-bottom: 1rem; font-family: 'Crimson Pro', serif;">Master Task List</h2>
            <table id="taskTable">
                <thead>
                    <tr>
                        <th class="sortable" onclick="sortTable(0)">Task ID</th>
                        <th class="sortable" onclick="sortTable(1)">Task Name</th>
                        <th class="sortable" onclick="sortTable(2)">Start Date</th>
                        <th class="sortable" onclick="sortTable(3)">Duration</th>
                        <th class="sortable" onclick="sortTable(4)">Priority</th>
                        <th class="sortable" onclick="sortTable(5)">Deliverable</th>
                        <th class="sortable" onclick="sortTable(6)">Completed</th>
                    </tr>
                </thead>
                <tbody id="taskTableBody">
                </tbody>
            </table>
        </div>

        <div id="timelineView" class="view">
            <h2 style="margin-bottom: 1.5rem; font-family: 'Crimson Pro', serif;">Weekly Timeline View</h2>
            <div class="timeline">
                <div class="week">
                    <div class="week-header">
                        <div class="week-title">Week 1: Feb 3-7, 2026</div>
                        <div>Systematic Review Protocol Sprint</div>
                    </div>
                    <div class="task-card" onclick="showTaskDetails('Systematic Review Protocol')">
                        <div class="task-header">
                            <div class="task-title">SRP-1 through SRP-8: Protocol Development</div>
                            <div class="task-duration">34 hours</div>
                        </div>
                        <div class="task-description">Complete all protocol tasks: PICO, eligibility, search strategy, background, data extraction, risk of bias, synthesis methods, and OSF registration</div>
                        <div><strong>Deliverable:</strong> Registered protocol with DOI by Friday Feb 7</div>
                    </div>
                </div>

                <div class="week">
                    <div class="week-header">
                        <div class="week-title">Week 2: Feb 10-14, 2026</div>
                        <div>Narrative Review + Grant Foundation</div>
                    </div>
                    <div class="task-card" onclick="showTaskDetails('Narrative Review')">
                        <div class="task-header">
                            <div class="task-title">NR-2: Complete narrative review</div>
                            <div class="task-duration">16 hours</div>
                        </div>
                        <div class="task-description">Finish missing sections, internal revision, submit for supervisor feedback</div>
                    </div>
                    <div class="task-card" onclick="showTaskDetails('Grant Application')">
                        <div class="task-header">
                            <div class="task-title">GA-2: Draft Specific Aims</div>
                            <div class="task-duration">12 hours</div>
                        </div>
                        <div class="task-description">One-page summary of grant objectives (highest priority section)</div>
                    </div>
                </div>

                <div class="week">
                    <div class="week-header">
                        <div class="week-title">Week 3: Feb 17-21, 2026</div>
                        <div>Grant Application Intensive</div>
                    </div>
                    <div class="task-card" onclick="showTaskDetails('Grant Application')">
                        <div class="task-header">
                            <div class="task-title">GA-3 through GA-9: Complete grant application</div>
                            <div class="task-duration">60 hours</div>
                        </div>
                        <div class="task-description">AI agents design, justification, feasibility, risk assessment, budget, compilation, supervisor review</div>
                        <div><strong>Deliverable:</strong> Grant submitted for expedited review by Feb 21</div>
                    </div>
                </div>

                <div class="week">
                    <div class="week-header">
                        <div class="week-title">Week 7: Mar 16-20, 2026</div>
                        <div>Proposal Finalization + Defense Prep</div>
                    </div>
                    <div class="task-card" onclick="showTaskDetails('Research Proposal')">
                        <div class="task-header">
                            <div class="task-title">RP-11: Finalize research proposal</div>
                            <div class="task-duration">16 hours</div>
                        </div>
                        <div class="task-description">Incorporate supervisor feedback, major revisions, defense preparation</div>
                        <div><strong>Deliverable:</strong> Final proposal ready by Mar 19</div>
                    </div>
                </div>

                <div class="week">
                    <div class="week-header">
                        <div class="week-title">Week 8-9: Mar 16-31, 2026</div>
                        <div>Defense Preparation & Execution</div>
                    </div>
                    <div class="task-card" onclick="showTaskDetails('Defense Preparation')">
                        <div class="task-header">
                            <div class="task-title">DEF-1 & DEF-2: Defense preparation and execution</div>
                            <div class="task-duration">44 hours</div>
                        </div>
                        <div class="task-description">Prepare presentation, anticipate questions, final document review, and PhD defense</div>
                        <div><strong>Deliverable:</strong> Completed PhD defense</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="ganttView" class="view">
            <h2 style="margin-bottom: 1.5rem; font-family: 'Crimson Pro', serif;">Gantt Chart</h2>
            <div style="background: var(--surface); padding: 2rem; border-radius: 8px;">
                <!-- Timeline ruler -->
                <div style="display: flex; margin-bottom: 1rem; padding-left: 250px;">
                    <div style="flex-grow: 1; display: flex; justify-content: space-between; padding: 0 1rem; border-bottom: 2px solid var(--border); padding-bottom: 0.5rem;">
                        <span style="font-size: 0.85rem; color: var(--text-light); font-weight: 600;">Feb 3</span>
                        <span style="font-size: 0.85rem; color: var(--text-light); font-weight: 600;">Feb 24</span>
                        <span style="font-size: 0.85rem; color: var(--text-light); font-weight: 600;">Mar 17</span>
                        <span style="font-size: 0.85rem; color: var(--text-light); font-weight: 600;">Apr 7</span>
                        <span style="font-size: 0.85rem; color: var(--text-light); font-weight: 600;">Apr 28</span>
                    </div>
                </div>
                <div class="gantt" id="ganttChart">
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for adding new task -->
    <div id="addTaskModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeAddTaskModal()">√ó</button>
            <h2 class="modal-title">‚ûï Add New Task</h2>
            <form id="addTaskForm" onsubmit="addNewTask(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label for="taskId">Task ID *</label>
                        <input type="text" id="taskId" placeholder="e.g., SRP-9, NR-5" required>
                        <div class="form-hint">Unique identifier for this task</div>
                    </div>
                    <div class="form-group">
                        <label for="taskCategory">Category/Deliverable *</label>
                        <select id="taskCategory" required>
                            <option value="">Select a category...</option>
                            <option value="Systematic Review Protocol">Systematic Review Protocol</option>
                            <option value="Narrative Review">Narrative Review</option>
                            <option value="Grant Application">Grant Application</option>
                            <option value="Research Proposal">Research Proposal</option>
                            <option value="Defense Preparation">Defense Preparation</option>
                            <option value="Other">Other</option>
                        </select>
                        <div class="form-hint">Which deliverable does this belong to?</div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="taskName">Task Name *</label>
                    <input type="text" id="taskName" placeholder="e.g., Complete data analysis" required>
                    <div class="form-hint">Clear, descriptive name for the task</div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="taskStart">Start Date *</label>
                        <input type="text" id="taskStart" placeholder="e.g., Feb 10 or Mar 5" required>
                        <div class="form-hint">Format: Month Day (e.g., Feb 15)</div>
                    </div>
                    <div class="form-group">
                        <label for="taskDuration">Duration *</label>
                        <input type="text" id="taskDuration" placeholder="e.g., 8 hours or 2 days" required>
                        <div class="form-hint">Time needed to complete (hours or days)</div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="taskPriority">Priority Level *</label>
                        <select id="taskPriority" required>
                            <option value="">Select priority...</option>
                            <option value="URGENT">üî¥ Urgent (deadline within days)</option>
                            <option value="HIGH">üü° High (critical path item)</option>
                            <option value="MEDIUM">üîµ Medium (important but flexible)</option>
                            <option value="LOW">‚ö™ Low (can be delayed)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="taskWeekStart">Week Number (for Gantt)</label>
                        <input type="number" id="taskWeekStart" placeholder="e.g., 0 = Feb 3, 7 = Feb 10" min="0" max="90">
                        <div class="form-hint">Days from Feb 3 (optional, auto-calculated)</div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="taskDeliverable">Deliverable/Output *</label>
                    <textarea id="taskDeliverable" placeholder="What gets produced? (e.g., Draft chapter, Completed analysis, Submitted document)" required></textarea>
                    <div class="form-hint">Tangible outcome when this task is complete</div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-cancel" onclick="closeAddTaskModal()">Cancel</button>
                    <button type="submit" class="btn btn-success">‚úì Add Task</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for detailed task view -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">√ó</button>
            <h2 class="modal-title" id="modalTitle"></h2>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        // Centralized data model
        const taskData = {
            tasks: [
                { id: 'SRP-1', name: 'Define PICO framework', start: 'Feb 3', duration: '4 hours', priority: 'URGENT', deliverable: 'PICO statement document', category: 'Systematic Review Protocol', weekStart: 0, durationDays: 0.5, completed: false },
                { id: 'SRP-2', name: 'Draft eligibility criteria', start: 'Feb 3', duration: '4 hours', priority: 'URGENT', deliverable: 'Eligibility criteria section', category: 'Systematic Review Protocol', weekStart: 0, durationDays: 0.5, completed: false },
                { id: 'SRP-3', name: 'Develop search strategy', start: 'Feb 4', duration: '8 hours', priority: 'URGENT', deliverable: 'Draft search strategy', category: 'Systematic Review Protocol', weekStart: 1, durationDays: 1, completed: false },
                { id: 'SRP-8', name: 'Compile and register protocol', start: 'Feb 7', duration: '4 hours', priority: 'URGENT', deliverable: 'Registered protocol with DOI', category: 'Systematic Review Protocol', weekStart: 4, durationDays: 0.5, completed: false },
                { id: 'NR-1', name: 'Assess current draft', start: 'Feb 10', duration: '4 hours', priority: 'HIGH', deliverable: 'Gap analysis document', category: 'Narrative Review', weekStart: 7, durationDays: 0.5, completed: false },
                { id: 'NR-7', name: 'Final polish', start: 'Mar 5', duration: '8 hours', priority: 'MEDIUM', deliverable: 'Final narrative review', category: 'Narrative Review', weekStart: 30, durationDays: 1, completed: false },
                { id: 'GA-2', name: 'Draft Specific Aims', start: 'Feb 14', duration: '12 hours', priority: 'URGENT', deliverable: 'Specific Aims page', category: 'Grant Application', weekStart: 11, durationDays: 1.5, completed: false },
                { id: 'GA-3', name: 'Write AI agents conceptual design', start: 'Feb 17', duration: '16 hours', priority: 'HIGH', deliverable: 'Agents methodology section', category: 'Grant Application', weekStart: 14, durationDays: 2, completed: false },
                { id: 'GA-10', name: 'Finalize grant application', start: 'Feb 27', duration: '12 hours', priority: 'URGENT', deliverable: 'Submitted grant application', category: 'Grant Application', weekStart: 24, durationDays: 1.5, completed: false },
                { id: 'RP-4', name: 'Develop research methodology', start: 'Feb 24', duration: '20 hours', priority: 'HIGH', deliverable: 'Methods section', category: 'Research Proposal', weekStart: 21, durationDays: 2.5, completed: false },
                { id: 'RP-11', name: 'Finalize research proposal', start: 'Mar 19', duration: '16 hours', priority: 'MEDIUM', deliverable: 'Final research proposal', category: 'Research Proposal', weekStart: 44, durationDays: 2, completed: false },
                { id: 'DEF-1', name: 'Defense preparation', start: 'Mar 16', duration: '40 hours', priority: 'HIGH', deliverable: 'Defense presentation and materials', category: 'Defense Preparation', weekStart: 41, durationDays: 5, completed: false },
                { id: 'DEF-2', name: 'PhD Defense', start: 'Mar 31', duration: '4 hours', priority: 'URGENT', deliverable: 'Completed defense', category: 'Defense Preparation', weekStart: 56, durationDays: 0.5, completed: false }
            ],
            header: {
                title: "Bleta's PhD Research Cronogram",
                subtitle: "3-Month Timeline for Four Concurrent Deliverables | February - April 2026"
            }
        };

        // Initialize from localStorage if exists
        function loadData() {
            const saved = localStorage.getItem('phdCronogram');
            const savedHeader = localStorage.getItem('phdCronogramHeader');
            
            if (saved) {
                try {
                    const savedTasks = JSON.parse(saved);
                    
                    // CRITICAL: Validate that saved data has proper categories
                    const validCategories = [
                        'Systematic Review Protocol',
                        'Narrative Review',
                        'Grant Application',
                        'Research Proposal',
                        'Defense Preparation'
                    ];
                    
                    // Count tasks by category
                    const categoryCounts = {};
                    savedTasks.forEach(t => {
                        const cat = t.category || 'Other';
                        categoryCounts[cat] = (categoryCounts[cat] || 0) + 1;
                    });
                    
                    console.log('üìä Saved data category counts:', categoryCounts);
                    
                    // Check if data is corrupted (too many "Other" or too few tasks)
                    const otherCount = categoryCounts['Other'] || 0;
                    const isCorrupted = savedTasks.length < 13 || otherCount > 5;
                    
                    if (isCorrupted) {
                        console.error('‚ö†Ô∏è CORRUPTED DATA DETECTED');
                        console.error('- Task count:', savedTasks.length, '(expected 13+)');
                        console.error('- Other category count:', otherCount, '(should be 0-2)');
                        console.error('- Category breakdown:', categoryCounts);
                        
                        localStorage.removeItem('phdCronogram');
                        localStorage.removeItem('phdCronogramHeader');
                        
                        alert('‚ö†Ô∏è Data Corruption Detected!\n\nYour saved data lost category information.\n\n‚úÖ Resetting to default tasks.\n\nüí° Please refresh the page (F5).');
                        
                        // Use default data
                        console.log('‚úÖ Using default tasks from taskData');
                        return;
                    }
                    
                    // Validate and map saved tasks
                    taskData.tasks = savedTasks.map(savedTask => {
                        const task = {
                            id: savedTask.id,
                            name: savedTask.name,
                            start: savedTask.start,
                            duration: savedTask.duration,
                            priority: savedTask.priority || 'MEDIUM',
                            deliverable: savedTask.deliverable,
                            category: savedTask.category || 'Other',
                            weekStart: savedTask.weekStart || 0,
                            durationDays: savedTask.durationDays || 1,
                            completed: savedTask.completed || false
                        };
                        
                        console.log(`Loaded task ${task.id} with category: "${task.category}"`);
                        return task;
                    });
                    
                    console.log('‚úÖ Total tasks loaded:', taskData.tasks.length);
                    console.log('‚úÖ Categories:', [...new Set(taskData.tasks.map(t => t.category))]);
                } catch (e) {
                    console.error('‚ùå Error loading saved data:', e);
                    console.log('Using default data');
                    localStorage.removeItem('phdCronogram');
                }
            } else {
                console.log('‚ÑπÔ∏è No saved data - using default tasks');
            }
            
            if (savedHeader) {
                try {
                    const headerData = JSON.parse(savedHeader);
                    taskData.header = headerData;
                    document.querySelector('h1').textContent = headerData.title;
                    document.querySelector('.subtitle').textContent = headerData.subtitle;
                } catch (e) {
                    console.error('Error loading header:', e);
                }
            }
        }

        // Show sync indicator
        function showSyncIndicator() {
            const indicator = document.getElementById('syncIndicator');
            indicator.classList.add('show');
            setTimeout(() => indicator.classList.remove('show'), 1500);
        }

        // Update all views
        function syncAllViews() {
            updateTableView();
            updateGanttView();
            showSyncIndicator();
        }

        // Update table view
        function updateTableView() {
            const tbody = document.getElementById('taskTableBody');
            tbody.innerHTML = '';
            
            taskData.tasks.forEach(task => {
                const row = document.createElement('tr');
                const priorityClass = task.priority === 'URGENT' ? 'priority-urgent' : 
                                     task.priority === 'HIGH' ? 'priority-high' : 'priority-medium';
                
                const completedStyle = task.completed ? 'style="opacity: 0.6; text-decoration: line-through;"' : '';
                
                row.innerHTML = `
                    <td ${completedStyle}>${task.id}</td>
                    <td ${completedStyle}>${task.name}</td>
                    <td ${completedStyle}><span class="editable" contenteditable="true" data-id="${task.id}" data-field="start">${task.start}</span></td>
                    <td ${completedStyle}><span class="editable" contenteditable="true" data-id="${task.id}" data-field="duration">${task.duration}</span></td>
                    <td ${completedStyle}><span class="${priorityClass}">${task.priority}</span></td>
                    <td ${completedStyle}>${task.deliverable}</td>
                    <td style="text-align: center;">
                        <input type="checkbox" 
                               data-id="${task.id}" 
                               ${task.completed ? 'checked' : ''} 
                               onchange="toggleTaskCompletion('${task.id}')"
                               style="width: 18px; height: 18px; cursor: pointer;">
                    </td>
                `;
                tbody.appendChild(row);
            });

            // Add event listeners to editable fields
            document.querySelectorAll('.editable').forEach(el => {
                el.addEventListener('blur', handleTableEdit);
                el.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        el.blur();
                    }
                });
            });
        }

        // Toggle task completion
        function toggleTaskCompletion(taskId) {
            const task = taskData.tasks.find(t => t.id === taskId);
            if (task) {
                task.completed = !task.completed;
                syncAllViews();
            }
        }

        // Handle table edits
        function handleTableEdit(e) {
            const taskId = e.target.dataset.id;
            const field = e.target.dataset.field;
            const newValue = e.target.textContent.trim();
            
            const task = taskData.tasks.find(t => t.id === taskId);
            if (task) {
                task[field] = newValue;
                
                if (field === 'duration') {
                    const hours = parseFloat(newValue);
                    task.durationDays = hours / 8;
                }
                
                syncAllViews();
            }
        }

        // Update Gantt view
        function updateGanttView() {
            const ganttContainer = document.getElementById('ganttChart');
            if (!ganttContainer) {
                console.error('Gantt container not found!');
                return;
            }
            
            const categories = [
                'Systematic Review Protocol',
                'Narrative Review', 
                'Grant Application',
                'Research Proposal',
                'Defense Preparation'
            ];
            
            ganttContainer.innerHTML = '';
            
            console.log('Rendering Gantt chart with', taskData.tasks.length, 'tasks');
            
            categories.forEach(category => {
                const categoryTasks = taskData.tasks.filter(t => t.category === category);
                if (categoryTasks.length > 0) {
                    const minStart = Math.min(...categoryTasks.map(t => t.weekStart));
                    const maxEnd = Math.max(...categoryTasks.map(t => t.weekStart + t.durationDays));
                    
                    const row = document.createElement('div');
                    row.className = 'gantt-row';
                    
                    // Get first and last dates
                    const sortedTasks = categoryTasks.sort((a, b) => a.weekStart - b.weekStart);
                    const startDate = sortedTasks[0].start;
                    const endDate = sortedTasks[sortedTasks.length - 1].start;
                    
                    // Calculate position and width as percentages
                    const leftPercent = (minStart / 90) * 100;
                    const widthPercent = Math.max(5, ((maxEnd - minStart) / 90) * 100); // Minimum 5% width
                    
                    console.log(`${category}: left=${leftPercent.toFixed(1)}%, width=${widthPercent.toFixed(1)}%`);
                    
                    row.innerHTML = `
                        <div class="gantt-label">${category}</div>
                        <div class="gantt-bar-container">
                            <div class="gantt-bar" 
                                 data-category="${category}" 
                                 style="left: ${leftPercent}%; width: ${widthPercent}%;">
                                ${startDate}${startDate !== endDate ? ' ‚Üí ' + endDate : ''}
                            </div>
                        </div>
                    `;
                    ganttContainer.appendChild(row);
                }
            });
            
            // Add custom categories
            const customCategories = [...new Set(taskData.tasks.map(t => t.category))].filter(c => !categories.includes(c));
            customCategories.forEach(category => {
                const categoryTasks = taskData.tasks.filter(t => t.category === category);
                if (categoryTasks.length > 0) {
                    const minStart = Math.min(...categoryTasks.map(t => t.weekStart));
                    const maxEnd = Math.max(...categoryTasks.map(t => t.weekStart + t.durationDays));
                    
                    const row = document.createElement('div');
                    row.className = 'gantt-row';
                    
                    const sortedTasks = categoryTasks.sort((a, b) => a.weekStart - b.weekStart);
                    const startDate = sortedTasks[0].start;
                    const endDate = sortedTasks[sortedTasks.length - 1].start;
                    
                    const leftPercent = (minStart / 90) * 100;
                    const widthPercent = Math.max(5, ((maxEnd - minStart) / 90) * 100);
                    
                    row.innerHTML = `
                        <div class="gantt-label">${category}</div>
                        <div class="gantt-bar-container">
                            <div class="gantt-bar" 
                                 data-category="${category}" 
                                 style="left: ${leftPercent}%; width: ${widthPercent}%;">
                                ${startDate}${startDate !== endDate ? ' ‚Üí ' + endDate : ''}
                            </div>
                        </div>
                    `;
                    ganttContainer.appendChild(row);
                }
            });

            console.log('Gantt chart rendered with', ganttContainer.children.length, 'rows');
            initDraggableGantt();
        }

        // Initialize draggable Gantt bars
        function initDraggableGantt() {
            const bars = document.querySelectorAll('.gantt-bar');
            bars.forEach(bar => {
                let isDragging = false;
                let startX;
                let startLeft;
                let container;

                bar.addEventListener('mousedown', (e) => {
                    isDragging = true;
                    startX = e.clientX;
                    container = bar.closest('.gantt-bar-container');
                    const rect = container.getBoundingClientRect();
                    startLeft = parseFloat(bar.style.left) * rect.width / 100;
                    bar.classList.add('dragging');
                    e.preventDefault();
                });

                document.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;

                    const rect = container.getBoundingClientRect();
                    const deltaX = e.clientX - startX;
                    const newLeft = startLeft + deltaX;
                    const newLeftPercent = Math.max(0, Math.min(95, (newLeft / rect.width) * 100));
                    
                    bar.style.left = newLeftPercent + '%';
                });

                document.addEventListener('mouseup', (e) => {
                    if (!isDragging) return;
                    
                    isDragging = false;
                    bar.classList.remove('dragging');
                    
                    const category = bar.dataset.category;
                    const newLeftPercent = parseFloat(bar.style.left);
                    const newStartDay = Math.round((newLeftPercent / 100) * 90);
                    
                    const categoryTasks = taskData.tasks.filter(t => t.category === category);
                    const offset = newStartDay - categoryTasks[0].weekStart;
                    
                    categoryTasks.forEach(task => {
                        task.weekStart += offset;
                        const startDate = new Date(2026, 1, 3);
                        startDate.setDate(startDate.getDate() + task.weekStart);
                        task.start = startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    });
                    
                    syncAllViews();
                });
            });
        }

        // View switching
        function switchView(view) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));

            if (view === 'table') {
                document.getElementById('tableView').classList.add('active');
                document.querySelector('.tab').classList.add('active');
            } else if (view === 'timeline') {
                document.getElementById('timelineView').classList.add('active');
                document.querySelectorAll('.tab')[1].classList.add('active');
            } else if (view === 'gantt') {
                document.getElementById('ganttView').classList.add('active');
                document.querySelectorAll('.tab')[2].classList.add('active');
            }
        }

        // Show modal with task details
        function showTaskDetails(category) {
            console.log('=== showTaskDetails Debug ===');
            console.log('Requested category:', `"${category}"`);
            console.log('Total tasks in taskData:', taskData.tasks.length);
            console.log('All categories:', [...new Set(taskData.tasks.map(t => t.category))]);
            
            const modal = document.getElementById('taskModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            
            if (!modal || !modalTitle || !modalBody) {
                console.error('Modal elements not found!');
                alert('Error: Modal not found. Please refresh the page.');
                return;
            }
            
            modalTitle.textContent = category + ' - Detailed Tasks';
            
            // Try exact match first
            let categoryTasks = taskData.tasks.filter(t => t.category === category);
            
            console.log('Exact match found:', categoryTasks.length, 'tasks');
            
            if (categoryTasks.length === 0) {
                const availableCategories = [...new Set(taskData.tasks.map(t => t.category))];
                console.error('No tasks found! Available categories:', availableCategories);
                
                modalBody.innerHTML = `
                    <div style="padding: 2rem;">
                        <p style="text-align: center; font-size: 1.1rem; margin-bottom: 1rem;">
                            <strong>‚ö†Ô∏è No tasks found in category "${category}"</strong>
                        </p>
                        <div style="background: #fef3c7; padding: 1rem; border-radius: 6px;">
                            <p><strong>üêõ Debug Information:</strong></p>
                            <p style="margin-top: 0.5rem;">Total tasks loaded: <strong>${taskData.tasks.length}</strong></p>
                            <p style="margin-top: 0.5rem;">Available categories:</p>
                            <ul style="margin-left: 2rem; margin-top: 0.5rem;">
                                ${availableCategories.map(cat => {
                                    const count = taskData.tasks.filter(t => t.category === cat).length;
                                    return `<li>"${cat}" ‚Üí ${count} tasks</li>`;
                                }).join('')}
                            </ul>
                            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 2px solid #fbbf24;">
                                <p><strong>üí° Solution:</strong></p>
                                <p style="margin-top: 0.5rem;">Your saved data may be corrupted. Click the <strong>"üîÑ Reset to Original"</strong> button above to restore default tasks.</p>
                            </div>
                        </div>
                    </div>
                `;
                modal.classList.add('active');
                return;
            }
            
            let tableHTML = `
                <table style="width: 100%; margin-top: 1rem; border-collapse: collapse;">
                    <thead style="background: var(--primary); color: white;">
                        <tr>
                            <th style="padding: 0.75rem; text-align: left;">Task ID</th>
                            <th style="padding: 0.75rem; text-align: left;">Task Name</th>
                            <th style="padding: 0.75rem; text-align: left;">Start Date</th>
                            <th style="padding: 0.75rem; text-align: left;">Duration</th>
                            <th style="padding: 0.75rem; text-align: left;">Deliverable</th>
                            <th style="padding: 0.75rem; text-align: center;">Completed</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            categoryTasks.forEach(task => {
                const completedStatus = task.completed ? '‚úì Yes' : '‚úó No';
                const completedStyle = task.completed ? 'style="opacity: 0.6; text-decoration: line-through;"' : '';
                tableHTML += `
                    <tr ${completedStyle} style="border-bottom: 1px solid var(--border);">
                        <td style="padding: 0.75rem;">${task.id}</td>
                        <td style="padding: 0.75rem;">${task.name}</td>
                        <td style="padding: 0.75rem;">${task.start}</td>
                        <td style="padding: 0.75rem;">${task.duration}</td>
                        <td style="padding: 0.75rem;">${task.deliverable}</td>
                        <td style="padding: 0.75rem; text-align: center; font-weight: bold;">${completedStatus}</td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table>';
            modalBody.innerHTML = tableHTML;
            modal.classList.add('active');
            console.log('‚úÖ Modal displayed with', categoryTasks.length, 'tasks');
        }

        function closeModal() {
            const modal = document.getElementById('taskModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        // Open add task modal
        function openAddTaskModal() {
            document.getElementById('addTaskModal').classList.add('active');
        }

        // Close add task modal
        function closeAddTaskModal() {
            document.getElementById('addTaskModal').classList.remove('active');
            document.getElementById('addTaskForm').reset();
        }

        // Add new task
        function addNewTask(event) {
            event.preventDefault();
            
            const taskId = document.getElementById('taskId').value.trim();
            const taskName = document.getElementById('taskName').value.trim();
            const taskStart = document.getElementById('taskStart').value.trim();
            const taskDuration = document.getElementById('taskDuration').value.trim();
            const taskPriority = document.getElementById('taskPriority').value;
            const taskCategory = document.getElementById('taskCategory').value;
            const taskDeliverable = document.getElementById('taskDeliverable').value.trim();
            const weekStart = document.getElementById('taskWeekStart').value;
            
            if (taskData.tasks.find(t => t.id === taskId)) {
                alert('A task with this ID already exists! Please use a unique ID.');
                return;
            }
            
            let durationDays = 0;
            if (taskDuration.toLowerCase().includes('hour')) {
                const hours = parseFloat(taskDuration);
                durationDays = hours / 8;
            } else if (taskDuration.toLowerCase().includes('day')) {
                durationDays = parseFloat(taskDuration);
            } else {
                const hours = parseFloat(taskDuration) || 1;
                durationDays = hours / 8;
            }
            
            let calculatedWeekStart = parseInt(weekStart) || 0;
            if (!weekStart && taskStart) {
                const months = ['jan', 'feb', 'mar', 'apr', 'may', 'jun'];
                const startLower = taskStart.toLowerCase();
                
                for (let i = 0; i < months.length; i++) {
                    if (startLower.includes(months[i])) {
                        const dayMatch = taskStart.match(/\d+/);
                        if (dayMatch) {
                            const day = parseInt(dayMatch[0]);
                            if (i === 1) {
                                calculatedWeekStart = day - 3;
                            } else if (i === 2) {
                                calculatedWeekStart = 25 + day;
                            } else if (i === 3) {
                                calculatedWeekStart = 56 + day;
                            }
                        }
                        break;
                    }
                }
            }
            
            const newTask = {
                id: taskId,
                name: taskName,
                start: taskStart,
                duration: taskDuration,
                priority: taskPriority,
                deliverable: taskDeliverable,
                category: taskCategory,
                weekStart: calculatedWeekStart,
                durationDays: durationDays,
                completed: false
            };
            
            taskData.tasks.push(newTask);
            syncAllViews();
            updateWeeklyTimeline();
            closeAddTaskModal();
            
            const indicator = document.getElementById('syncIndicator');
            indicator.textContent = `‚úì Task "${taskId}" added successfully!`;
            indicator.classList.add('show');
            setTimeout(() => {
                indicator.textContent = '‚úì Views synchronized';
                indicator.classList.remove('show');
            }, 3000);
            
            saveData();
        }

        // Update weekly timeline view
        function updateWeeklyTimeline() {
            const timelineContainer = document.querySelector('.timeline');
            if (!timelineContainer) return;
            
            const originalTaskIds = ['SRP-1', 'SRP-2', 'SRP-3', 'SRP-8', 'NR-1', 'NR-7', 'GA-2', 'GA-3', 'GA-10', 'RP-4', 'RP-11', 'DEF-1', 'DEF-2'];
            const customTasks = taskData.tasks.filter(task => !originalTaskIds.includes(task.id));
            
            const existingCustomCards = timelineContainer.querySelectorAll('.custom-task-card');
            existingCustomCards.forEach(card => card.remove());
            
            if (customTasks.length > 0) {
                const categoryGroups = {};
                customTasks.forEach(task => {
                    if (!categoryGroups[task.category]) {
                        categoryGroups[task.category] = [];
                    }
                    categoryGroups[task.category].push(task);
                });
                
                Object.keys(categoryGroups).forEach(category => {
                    const tasks = categoryGroups[category];
                    const weekNum = Math.floor(tasks[0].weekStart / 7) + 1;
                    const weekStart = new Date(2026, 1, 3);
                    weekStart.setDate(weekStart.getDate() + (weekNum - 1) * 7);
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekEnd.getDate() + 6);
                    
                    let weekDiv = null;
                    const existingWeeks = timelineContainer.querySelectorAll('.week');
                    existingWeeks.forEach(week => {
                        const weekTitle = week.querySelector('.week-title').textContent;
                        if (weekTitle.includes(`Week ${weekNum}:`)) {
                            weekDiv = week;
                        }
                    });
                    
                    if (!weekDiv) {
                        weekDiv = document.createElement('div');
                        weekDiv.className = 'week';
                        weekDiv.innerHTML = `
                            <div class="week-header">
                                <div class="week-title">Week ${weekNum}: ${weekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${weekEnd.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</div>
                                <div>Custom Tasks</div>
                            </div>
                        `;
                        timelineContainer.appendChild(weekDiv);
                    }
                    
                    tasks.forEach(task => {
                        const taskCard = document.createElement('div');
                        taskCard.className = 'task-card custom-task-card';
                        taskCard.onclick = () => showTaskDetails(category);
                        taskCard.innerHTML = `
                            <div class="task-header">
                                <div class="task-title">${task.id}: ${task.name}</div>
                                <div class="task-duration">${task.duration}</div>
                            </div>
                            <div class="task-description">Category: ${task.category}</div>
                            <div><strong>Deliverable:</strong> ${task.deliverable}</div>
                        `;
                        weekDiv.appendChild(taskCard);
                    });
                });
            }
        }

        // Close modals on outside click
        document.getElementById('taskModal').addEventListener('click', (e) => {
            if (e.target.id === 'taskModal') {
                closeModal();
            }
        });

        document.getElementById('addTaskModal').addEventListener('click', (e) => {
            if (e.target.id === 'addTaskModal') {
                closeAddTaskModal();
            }
        });

        // Table sorting
        function sortTable(columnIndex) {
            const table = document.getElementById('taskTable');
            const tbody = document.getElementById('taskTableBody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const headers = table.querySelectorAll('th');
            
            headers.forEach(h => h.classList.remove('sorted-asc', 'sorted-desc'));

            const currentHeader = headers[columnIndex];
            const isAscending = !currentHeader.dataset.sortDir || currentHeader.dataset.sortDir === 'desc';
            
            rows.sort((a, b) => {
                const aValue = a.cells[columnIndex].textContent.trim();
                const bValue = b.cells[columnIndex].textContent.trim();
                
                if (isAscending) {
                    return aValue.localeCompare(bValue, undefined, { numeric: true });
                } else {
                    return bValue.localeCompare(aValue, undefined, { numeric: true });
                }
            });

            rows.forEach(row => tbody.appendChild(row));
            
            currentHeader.classList.add(isAscending ? 'sorted-asc' : 'sorted-desc');
            currentHeader.dataset.sortDir = isAscending ? 'asc' : 'desc';
        }

        // Save data
        function saveData() {
            const data = taskData.tasks.map(task => ({
                id: task.id,
                name: task.name,
                start: task.start,
                duration: task.duration,
                priority: task.priority,
                deliverable: task.deliverable,
                category: task.category,
                weekStart: task.weekStart,
                durationDays: task.durationDays,
                completed: task.completed
            }));

            const headerData = {
                title: document.querySelector('h1').textContent,
                subtitle: document.querySelector('.subtitle').textContent
            };

            localStorage.setItem('phdCronogram', JSON.stringify(data));
            localStorage.setItem('phdCronogramHeader', JSON.stringify(headerData));
            
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '‚úì Saved!';
            btn.style.background = 'var(--success)';
            btn.style.color = 'white';
            
            setTimeout(() => {
                btn.textContent = originalText;
                btn.style.background = '';
                btn.style.color = '';
            }, 2000);
        }

        function resetData() {
            if (confirm('‚ö†Ô∏è This will delete all saved data and reload the page with original tasks. Continue?')) {
                console.log('Clearing localStorage...');
                localStorage.removeItem('phdCronogram');
                localStorage.removeItem('phdCronogramHeader');
                console.log('localStorage cleared, reloading page...');
                location.reload();
            }
        }

        function showDebugInfo() {
            const info = {
                totalTasks: taskData.tasks.length,
                categories: [...new Set(taskData.tasks.map(t => t.category))],
                tasksByCategory: {},
                hasLocalStorage: !!localStorage.getItem('phdCronogram')
            };
            
            taskData.tasks.forEach(task => {
                if (!info.tasksByCategory[task.category]) {
                    info.tasksByCategory[task.category] = [];
                }
                info.tasksByCategory[task.category].push(task.id);
            });
            
            const debugHTML = `
                <h3 style="margin-bottom: 1rem;">Debug Information</h3>
                <div style="background: #f9fafb; padding: 1rem; border-radius: 6px; font-family: monospace; font-size: 0.9rem;">
                    <p><strong>Total Tasks:</strong> ${info.totalTasks}</p>
                    <p><strong>Has Saved Data:</strong> ${info.hasLocalStorage ? 'Yes' : 'No'}</p>
                    <p><strong>Categories Found:</strong></p>
                    <ul style="margin-left: 2rem;">
                        ${info.categories.map(cat => 
                            `<li>${cat}: ${info.tasksByCategory[cat].length} tasks (${info.tasksByCategory[cat].join(', ')})</li>`
                        ).join('')}
                    </ul>
                    <p style="margin-top: 1rem;"><strong>Recommendation:</strong></p>
                    <p>${info.hasLocalStorage ? 
                        'If you see unexpected categories or missing tasks, click "üîÑ Reset to Original" to reload default data.' : 
                        'No saved data found. Using default tasks.'
                    }</p>
                </div>
            `;
            
            const modal = document.getElementById('taskModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            
            modalTitle.textContent = 'üêõ Debug Information';
            modalBody.innerHTML = debugHTML;
            modal.classList.add('active');
        }

        // Print cronogram
        function printCronogram() {
            try {
                console.log('Preparing to print...');
                
                // Show all views for printing
                document.querySelectorAll('.view').forEach(view => {
                    view.style.display = 'block';
                });
                
                // Small delay to ensure rendering is complete
                setTimeout(() => {
                    console.log('Opening print dialog...');
                    window.print();
                    
                    // Restore view visibility after print
                    setTimeout(() => {
                        document.querySelectorAll('.view').forEach(view => {
                            if (!view.classList.contains('active')) {
                                view.style.display = 'none';
                            }
                        });
                    }, 500);
                }, 100);
                
            } catch (error) {
                console.error('Error printing:', error);
                alert('Error opening print dialog. Please try using your browser\'s print function (Ctrl+P or Cmd+P).');
            }
        }

        function exportToExcel() {
            try {
                console.log('Starting CSV export...');
                let csv = 'Task ID,Task Name,Start Date,Duration,Priority,Deliverable,Completed\n';
                
                taskData.tasks.forEach(task => {
                    const completedStatus = task.completed ? 'Yes' : 'No';
                    const rowData = [task.id, task.name, task.start, task.duration, task.priority, task.deliverable, completedStatus];
                    csv += rowData.map(cell => `"${cell}"`).join(',') + '\n';
                });

                console.log('CSV content generated, creating blob...');
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.style.display = 'none';
                link.href = url;
                link.download = 'Bleta_PhD_Cronogram_' + new Date().toISOString().split('T')[0] + '.csv';
                
                document.body.appendChild(link);
                console.log('Triggering download...');
                link.click();
                
                // Cleanup
                setTimeout(() => {
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);
                    console.log('‚úì CSV export complete!');
                }, 100);
                
                // Show success message
                const indicator = document.getElementById('syncIndicator');
                if (indicator) {
                    indicator.textContent = '‚úì CSV downloaded!';
                    indicator.classList.add('show');
                    setTimeout(() => {
                        indicator.textContent = '‚úì Views synchronized';
                        indicator.classList.remove('show');
                    }, 2000);
                }
            } catch (error) {
                console.error('Error exporting CSV:', error);
                alert('Error exporting to CSV. Please try again.\n\nError: ' + error.message);
            }
        }

        // Initialize on page load
        window.addEventListener('load', () => {
            loadData();
            
            // Validate data integrity
            const expectedCategories = [
                'Systematic Review Protocol',
                'Narrative Review',
                'Grant Application',
                'Research Proposal',
                'Defense Preparation'
            ];
            
            const actualCategories = [...new Set(taskData.tasks.map(t => t.category))];
            const hasAllExpectedCategories = expectedCategories.every(cat => actualCategories.includes(cat));
            
            // Count "Other" category tasks
            const otherCategoryCount = taskData.tasks.filter(t => t.category === 'Other').length;
            
            console.log('=== DATA VALIDATION ===');
            console.log('Expected categories:', expectedCategories);
            console.log('Actual categories:', actualCategories);
            console.log('Task count:', taskData.tasks.length);
            console.log('Tasks in "Other" category:', otherCategoryCount);
            console.log('Has all expected:', hasAllExpectedCategories);
            
            // Data is corrupted if:
            // - Missing expected categories
            // - Too few tasks (should be 13)
            // - Too many tasks in "Other" (should be 0)
            const isCorrupted = !hasAllExpectedCategories || 
                               taskData.tasks.length < 13 || 
                               otherCategoryCount > 3;
            
            if (isCorrupted) {
                console.error('‚ö†Ô∏è DATA CORRUPTION DETECTED!');
                console.error('Reasons:');
                if (!hasAllExpectedCategories) console.error('- Missing expected categories');
                if (taskData.tasks.length < 13) console.error('- Too few tasks:', taskData.tasks.length);
                if (otherCategoryCount > 3) console.error('- Too many "Other" tasks:', otherCategoryCount);
                
                const warningBanner = document.getElementById('corruptionWarning');
                if (warningBanner) {
                    warningBanner.style.display = 'block';
                    // Scroll to top to make sure user sees it
                    window.scrollTo(0, 0);
                }
            }
            
            syncAllViews();
            updateWeeklyTimeline();
        });
    </script>
</body>
</html>
